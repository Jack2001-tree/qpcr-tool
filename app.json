[{"name":"app.R","content":"# æ£€æŸ¥å¹¶åŠ è½½æ‰€æœ‰å¿…éœ€çš„åŒ…\nlibrary(shiny)\nlibrary(munsell)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(stringr)\nlibrary(readxl)\nlibrary(combinat)\nlibrary(patchwork)\nlibrary(DT)\nlibrary(ggprism) \nlibrary(agricolae)\nlibrary(rstatix)\nlibrary(ggpubr)\nlibrary(svglite)\nlibrary(bslib)\nlibrary(purrr)  # <--- å¿…é¡»æ·»åŠ è¿™ä¸ªåŒ…æ¥æ”¯æŒ map_dfr\n\n# ç¯å¢ƒè®¾ç½®\noptions(shiny.usecairo = FALSE)\n\n# =======================================================\n# 1. æ ¸å¿ƒè®¡ç®—å¼•æ“ (ä¿æŒä¸å˜)\n# =======================================================\nprocess_gene_logic <- function(df, target_gene, mode, trend_ctrl, paired_ctrl, paired_treat, top_n) {\n  if (is.null(df) || nrow(df) == 0) return(NULL) # æ·»åŠ åŸºç¡€ç©ºå€¼æ£€æŸ¥\n  gene_data <- df %>% filter(Gene == target_gene)\n  if (nrow(gene_data) == 0) return(NULL)\n  \n  if (mode == \"trend\") {\n    ctrl_name <- trend_ctrl\n    all_groups <- unique(gene_data$Age)\n  } else {\n    ctrl_name <- paired_ctrl\n    all_groups <- c(paired_ctrl, paired_treat)\n    gene_data <- gene_data %>% filter(Age %in% all_groups)\n  }\n  ctrl_reps <- gene_data %>% filter(Age == ctrl_name) %>% pull(Bio_Rep) %>% unique()\n  if(length(ctrl_reps) < 3) return(NULL)\n  ctrl_combos <- combn(ctrl_reps, 3, simplify = FALSE)\n  all_scenarios_list <- list()\n  for(d0_combo in ctrl_combos) {\n    d0_base_df <- gene_data %>% filter(Age == ctrl_name, Bio_Rep %in% d0_combo) %>% distinct(Bio_Rep, Delta_Ct_Mean) %>% arrange(Bio_Rep)\n    d0_ids <- d0_base_df$Bio_Rep\n    d0_dCts <- d0_base_df$Delta_Ct_Mean\n    current_scenario_data <- list(); current_scenario_score <- 0\n    for(grp in all_groups) {\n      age_df <- gene_data %>% filter(Age == grp)\n      if(grp == ctrl_name) {\n        res <- age_df %>% filter(Bio_Rep %in% d0_combo) %>% mutate(ddCt = Delta_Ct - Delta_Ct_Mean, RelExp_Hole = 2^(-ddCt)) %>%\n          group_by(Bio_Rep) %>% mutate(Bio_RelExp = mean(RelExp_Hole)) %>% ungroup() %>%\n          mutate(Pairing = paste0(Bio_Rep, \" vs \", Bio_Rep)) %>% select(Gene, Age, Bio_Rep, Bio_RelExp, Pairing) %>% distinct()\n        current_scenario_data[[grp]] <- res; current_scenario_score <- current_scenario_score + sd(res$Bio_RelExp)\n      } else {\n        reps_in_age <- unique(age_df$Bio_Rep)\n        if(length(reps_in_age) >= 3) {\n          ac_combos <- combn(reps_in_age, 3, simplify = FALSE)\n          best_age_sd <- Inf; best_age_df <- NULL\n          for(ac in ac_combos) {\n            test_df <- age_df %>% filter(Bio_Rep %in% ac)\n            exp_dCt_df <- test_df %>% distinct(Bio_Rep, Delta_Ct_Mean)\n            p_dCts_list <- permn(exp_dCt_df$Delta_Ct_Mean); p_ids_list <- permn(exp_dCt_df$Bio_Rep)\n            for(i in 1:length(p_dCts_list)) {\n              rel_exps <- 2^-(p_dCts_list[[i]] - d0_dCts) \n              if(sd(rel_exps) < best_age_sd) {\n                best_age_sd <- sd(rel_exps)\n                best_age_df <- tibble(Gene = target_gene, Age = grp, Bio_Rep = p_ids_list[[i]], Bio_RelExp = rel_exps, Pairing = paste0(p_ids_list[[i]], \" vs \", d0_ids))\n              }\n            }\n          }\n          current_scenario_data[[grp]] <- best_age_df; current_scenario_score <- current_scenario_score + best_age_sd\n        }\n      }\n    }\n    scenario_key <- paste(d0_combo, collapse=\"_\")\n    all_scenarios_list[[scenario_key]] <- list(score = current_scenario_score, data = bind_rows(current_scenario_data))\n  }\n  sorted_idx <- order(sapply(all_scenarios_list, function(x) x$score))\n  \n  return(purrr::map_dfr(head(sorted_idx, top_n), function(idx) { \n    all_scenarios_list[[idx]]$data %>% mutate(Rank = which(sorted_idx == idx)) \n  }))\n}\n\n# =======================================================\n# 2. UI ç•Œé¢\n# =======================================================\ngreek_chars <- c(\"Î±\", \"Î²\", \"Î³\", \"Î´\", \"Îµ\", \"Î¶\", \"Î·\", \"Î¸\", \"Îº\", \"Î»\", \"Î¼\", \"Î½\", \"Î¾\", \"Ï€\", \"Ï\", \"Ïƒ\", \"Ï„\", \"Ï†\", \"Ï‡\", \"Ïˆ\", \"Ï‰\", \"Î”\")\n\nui <- fluidPage(\n  theme = bs_theme(version = 5, bootswatch = \"flatly\"),\n  tags$head(\n    tags$style(HTML(\"\n      body { background-color: #f8fafc; }\n      .sidebar-box { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; }\n      .greek-btn { color: #000000 !important; font-weight: 800 !important; background: #ffffff; border: 1px solid #cbd5e1; margin: 2px; padding: 6px 10px; border-radius: 4px; }\n      .btn-run { background: #1e293b !important; color: #fff !important; width: 100%; border-radius: 8px; font-weight: bold; margin-top: 15px; height: 45px; border: none; }\n      .preview-box { background: #e2e8f0; border-radius: 12px; padding: 25px; display: flex; justify-content: center; overflow: auto; min-height: 500px; }\n      .section-tag { font-size: 11px; color: #64748b; text-transform: uppercase; margin: 15px 0 8px 0; font-weight: 800; border-bottom: 2px solid #f1f5f9; }\n    \"))\n  ),\n  \n  fluidRow(\n    column(12, h3(\"Master qPCR beta 2.0\", style=\"margin: 20px 0; font-weight: 850; color: #0f172a; text-align:center;\"))\n  ),\n  \n  fluidRow(style = \"padding: 0 20px;\",\n           column(4,\n                  div(class = \"sidebar-box\",\n                      tabsetPanel(id = \"config_tabs\",\n                                  tabPanel(\"æ–‡ä»¶/æ ‡é¢˜\",\n                                           br(),\n                                           fileInput(\"file\", \"ä¸Šä¼ æ•°æ®æ–‡ä»¶\"),\n                                           radioButtons(\"work_mode\", \"åˆ†ææ¨¡å¼\", choices = c(\"è¶‹åŠ¿\" = \"trend\", \"é…å¯¹\" = \"paired\"), inline = T),\n                                           uiOutput(\"mode_ui\"),\n                                           hr(),\n                                           textInput(\"plot_title\", \"å›¾è¡¨ä¸»æ ‡é¢˜\", \"\"),\n                                           tags$div(lapply(greek_chars, function(char) actionButton(paste0(\"btn_\", char), char, class = \"greek-btn\")))\n                                  ),\n                                  tabPanel(\"å›¾å½¢/é…è‰²\",\n                                           br(),\n                                           fluidRow(\n                                             column(6, textInput(\"xlab_text\", \"Xè½´æ ‡é¢˜\", \"Groups\")),\n                                             column(6, textInput(\"ylab_text\", \"Yè½´æ ‡é¢˜\", \"Relative Expression\"))\n                                           ),\n                                           div(class=\"section-tag\", \"Yè½´å¸ƒå±€æ§åˆ¶ (New)\"),\n                                           checkboxInput(\"y_expand\", \"æŸ±å­è´´ç´§ X è½´ (æ— ç¼éš™)\", TRUE),\n                                           sliderInput(\"y_top_gap\", \"é¡¶éƒ¨é¢„ç•™å‡€ç©º (é˜²æ­¢åˆ‡æ–­å­—æ¯)\", 0.05, 0.5, 0.15, step=0.05),\n                                           div(class=\"section-tag\", \"é¢œè‰²æ§åˆ¶\"),\n                                           checkboxInput(\"use_custom_cols\", \"å¯ç”¨è‡ªå®šä¹‰é…è‰²\", FALSE),\n                                           conditionalPanel(\n                                             condition = \"input.use_custom_cols == false\",\n                                             selectInput(\"palette\", \"é¢„è®¾æœŸåˆŠé…è‰²\", choices = c(\"Nature (NPG)\"=\"npg\", \"Science (AAAS)\"=\"aaas\", \"Lancet\"=\"lancet\", \"NEJM\"=\"nejm\", \"JAMA\"=\"jama\"))\n                                           ),\n                                           conditionalPanel(\n                                             condition = \"input.use_custom_cols == true\",\n                                             textInput(\"custom_cols\", \"è¾“å…¥é¢œè‰²(é€—å·éš”å¼€)\", \"royalblue, firebrick, seagreen, gold\")\n                                           ),\n                                           div(class=\"section-tag\", \"å…ƒç´ è°ƒèŠ‚\"),\n                                           sliderInput(\"bar_width\", \"æŸ±å®½\", 0.2, 1, 0.6),\n                                           sliderInput(\"bar_lwd\", \"æŸ±è¾¹æ¡†çº¿å®½\", 0.1, 3, 0.8),\n                                           checkboxInput(\"show_points\", \"æ˜¾ç¤ºæ•£ç‚¹\", T),\n                                           sliderInput(\"point_size\", \"æ•£ç‚¹å¤§å°\", 1, 8, 3.5),\n                                           sliderInput(\"sig_size\", \"ç»Ÿè®¡æ ‡è®°å¤§å°\", 2, 15, 6),\n                                           sliderInput(\"sig_lwd\", \"çº¿æ®µç²—ç»†\", 0.5, 4, 1)\n                                  ),\n                                  tabPanel(\"å°ºå¯¸/å­—å·\",\n                                           br(),\n                                           div(class=\"section-tag\", \"ç”»å¸ƒå°ºå¯¸ (Inch)\"),\n                                           fluidRow(\n                                             column(6, numericInput(\"num_w\", \"å®½åº¦ (W)\", 6, step=0.1)),\n                                             column(6, numericInput(\"num_h\", \"é«˜åº¦ (H)\", 5, step=0.1))\n                                           ),\n                                           div(class=\"section-tag\", \"ç‹¬ç«‹å­—å·ç²¾è°ƒ\"),\n                                           selectInput(\"font_family\", \"å­—ä½“æ—\", choices = c(\"Arial (Sans)\"=\"sans\", \"Times New Roman (Serif)\"=\"serif\")),\n                                           sliderInput(\"title_size\", \"ä¸»æ ‡é¢˜å­—å·\", 10, 35, 18),\n                                           fluidRow(\n                                             column(6, sliderInput(\"xtitle_size\", \"Xè½´æ ‡é¢˜\", 8, 25, 14)),\n                                             column(6, sliderInput(\"ytitle_size\", \"Yè½´æ ‡é¢˜\", 8, 25, 14))\n                                           ),\n                                           fluidRow(\n                                             column(6, sliderInput(\"xtext_size\", \"Xè½´åˆ»åº¦\", 6, 20, 11)),\n                                             column(6, sliderInput(\"ytext_size\", \"Yè½´åˆ»åº¦\", 6, 20, 11))\n                                           ),\n                                           sliderInput(\"axis_lwd\", \"åæ ‡è½´ç²—ç»†\", 0.5, 4, 1.2)\n                                  )\n                      ),\n                      actionButton(\"run\", \"ğŸš€ æ‰§è¡Œå¯»ä¼˜åˆ†æ\", class = \"btn-run\"),\n                      hr(),\n                      fluidRow(\n                        column(6, downloadButton(\"download_pdf\", \"PDF\", class=\"w-100 btn-sm\")),\n                        column(6, downloadButton(\"download_svg\", \"SVG\", class=\"w-100 btn-sm\"))\n                      )\n                  )\n           ),\n           \n           column(8,\n                  div(class = \"sidebar-box\",\n                      tabsetPanel(\n                        tabPanel(\"ğŸ“Š å¯è§†åŒ–ç»“æœ\",\n                                 br(),\n                                 uiOutput(\"gene_selector\"),\n                                 div(class=\"preview-box\",\n                                     plotOutput(\"main_plot\", width = \"auto\", height = \"auto\")\n                                 ),\n                                 hr(),\n                                 h5(\"å…¶ä»–å€™é€‰æ–¹æ¡ˆé¢„è§ˆ (Rank 2-12)\"),\n                                 # å¢åŠ æ»šåŠ¨æ¡ä»¥é€‚åº”å¤šå›¾\n                                 div(style=\"overflow-y: scroll; height: 800px;\", plotOutput(\"preview_plot\", height = \"1200px\"))\n                        ),\n                        tabPanel(\"ğŸ“‘ æ•°æ®è®¡ç®—è¡¨\", br(), DTOutput(\"rank1_detail_table\")),\n                        tabPanel(\"ğŸ—„ï¸ åŸå§‹æ•°æ®\", br(), DTOutput(\"raw_table\"))\n                      )\n                  )\n           )\n  )\n)\n\n# =======================================================\n# 3. Server é€»è¾‘\n# =======================================================\nserver <- function(input, output, session) {\n  \n  observe({\n    lapply(greek_chars, function(char) {\n      observeEvent(input[[paste0(\"btn_\", char)]], {\n        updateTextInput(session, \"plot_title\", value = paste0(input$plot_title, char))\n      })\n    })\n  })\n  \n  data_prepared <- reactive({\n    req(input$file)\n    tryCatch({\n      ext <- tools::file_ext(input$file$name)\n      raw_df <- if(ext == \"csv\") read.csv(input$file$datapath, check.names=F) else read_excel(input$file$datapath)\n      cols <- colnames(raw_df)\n      \n      if (all(c(\"Gene\", \"Age\", \"Bio_Rep\", \"Ct_Target\", \"Ct_Ref\") %in% cols)) {\n        df <- raw_df %>% mutate(across(c(Ct_Target, Ct_Ref), ~as.numeric(as.character(.))), Age=as.character(Age), Bio_Rep=as.character(Bio_Rep))\n      } else {\n        find_col <- function(keys) { match <- cols[as.logical(rowSums(sapply(keys, function(k) grepl(k, cols, ignore.case=T))))]; return(match[1]) }\n        col_s <- find_col(c(\"Sample\", \"Name\")); col_t <- find_col(c(\"Target\", \"Gene\")); col_c <- find_col(c(\"CT\", \"Ct\"))\n        df <- raw_df %>% select(SN=!!col_s, TN=!!col_t, CTV=!!col_c) %>%\n          mutate(Ct_V = as.numeric(as.character(CTV)), SN=str_trim(as.character(SN))) %>%\n          filter(!is.na(Ct_V)) %>%\n          mutate(Age = as.character(str_match(SN, \"(.*?)(\\\\d+)$\")[,2]), Bio_Rep = as.character(str_match(SN, \"(.*?)(\\\\d+)$\")[,3]),\n                 Is_Ref = str_detect(TN, \"-\"), Gene = if_else(Is_Ref, str_remove(TN, \".*-\"), TN)) %>%\n          filter(!is.na(Age)) %>% group_by(Gene, Age, Bio_Rep, Is_Ref) %>% mutate(Tech_Idx = row_number()) %>% ungroup() %>%\n          pivot_wider(id_cols = c(Gene, Age, Bio_Rep, Tech_Idx), names_from = Is_Ref, values_from = Ct_V) %>%\n          rename(Ct_Target = `FALSE`, Ct_Ref = `TRUE`)\n      }\n      df %>% filter(!is.na(Ct_Target), !is.na(Ct_Ref)) %>% group_by(Gene, Age, Bio_Rep) %>%\n        mutate(Ref_Mean = mean(Ct_Ref, na.rm = T)) %>% ungroup() %>%\n        mutate(Delta_Ct = Ct_Target - Ref_Mean) %>% group_by(Gene, Age, Bio_Rep) %>%\n        mutate(Delta_Ct_Mean = mean(Delta_Ct, na.rm = T)) %>% ungroup()\n    }, error = function(e) return(NULL))\n  })\n  \n  output$mode_ui <- renderUI({\n    req(data_prepared()); ages <- sort(unique(data_prepared()$Age))\n    if (input$work_mode == \"trend\") textInput(\"ctrl_name\", \"å¯¹ç…§ç»„:\", value = ages[1])\n    else tagList(selectInput(\"paired_ctrl\", \"å¯¹ç…§ç»„:\", choices = ages), selectInput(\"paired_treat\", \"å®éªŒç»„:\", choices = ages, selected = ages[2]))\n  })\n  \n  results <- eventReactive(input$run, {\n    req(data_prepared())\n    withProgress(message = 'æ­£åœ¨å…¨æ’åˆ—å¯»ä¼˜...', value = 0, {\n      genes <- unique(data_prepared()$Gene); all_res <- list()\n      for(i in seq_along(genes)) {\n        res <- process_gene_logic(data_prepared(), genes[i], input$work_mode, input$ctrl_name, input$paired_ctrl, input$paired_treat, 12)\n        if(!is.null(res)) all_res[[genes[i]]] <- res\n        setProgress(i/length(genes))\n      }\n      all_res\n    })\n  })\n  \n  output$gene_selector <- renderUI({ req(results()); selectInput(\"selected_gene\", \"åˆ†æåŸºå› :\", choices = names(results())) })\n  observeEvent(input$selected_gene, { updateTextInput(session, \"plot_title\", value = input$selected_gene) })\n  \n  # =======================================================\n  # ç»˜å›¾é€»è¾‘ (é›†æˆä¿®æ­£ç‰ˆï¼šè´´è½´ + å‡€ç©º + è¾¹è·ä¿®å¤)\n  # =======================================================\n  plot_standard <- function(data, is_main = TRUE) {\n    req(data, nrow(data) > 0)\n    \n    # 1. å˜é‡å®‰å…¨æ£€æŸ¥\n    ctrl <- if(input$work_mode == \"trend\") input$ctrl_name else input$paired_ctrl\n    if (is.null(ctrl) || !(ctrl %in% data$Age)) ctrl <- data$Age[1]\n    \n    # 2. ç»Ÿè®¡è®¡ç®—\n    levels_order <- c(ctrl, setdiff(unique(data$Age), ctrl))\n    stats <- data %>% group_by(Age) %>% summarise(M=mean(Bio_RelExp), S=sd(Bio_RelExp), .groups=\"drop\") %>% mutate(Age = factor(Age, levels = levels_order))\n    \n    # 3. Yè½´èŒƒå›´åŠ¨æ€è®¡ç®— (è§£å†³å­—æ¯è¢«åˆ‡æ–­é—®é¢˜)\n    # è·å– UI è¾“å…¥ï¼Œå¸¦é»˜è®¤å€¼é˜²æ­¢æŠ¥é”™\n    use_expand <- if(!is.null(input$y_expand)) input$y_expand else TRUE\n    top_gap_mult <- if(!is.null(input$y_top_gap)) input$y_top_gap else 0.15\n    \n    max_val <- max(stats$M + stats$S, na.rm=T)\n    y_limit_top <- max_val * (1 + top_gap_mult)\n    y_expand_vec <- if(use_expand) c(0, 0) else expansion(mult = c(0.05, top_gap_mult))\n    \n    # 4. é…è‰²\n    if(input$use_custom_cols) {\n      final_cols <- str_trim(unlist(strsplit(input$custom_cols, \",\")))\n    } else {\n      palette_list <- list(npg=c(\"#E64B35\",\"#4DBBD5\",\"#00A087\"), aaas=c(\"#3B4992\",\"#EE0000\",\"#008B45\"), \n                           lancet=c(\"#00468B\",\"#ED0000\",\"#42B540\"), nejm=c(\"#BC3C29\",\"#0072B5\",\"#E18727\"), jama=c(\"#374E55\",\"#DF8F44\",\"#00A1D5\"))\n      final_cols <- palette_list[[input$palette]]\n    }\n    \n    # 5. ç»˜å›¾\n    p <- ggplot(stats, aes(x=Age, y=M)) +\n      geom_bar(aes(fill=Age), stat=\"identity\", width=input$bar_width, color=\"black\", linewidth=input$bar_lwd) + \n      geom_errorbar(aes(ymin=M, ymax=M+S), width=0.12, linewidth=input$sig_lwd) +\n      theme_prism() + \n      theme(\n        # ä¿®å¤ Figure margins too largeï¼šéä¸»å›¾ä½¿ç”¨æå°è¾¹è·\n        plot.margin = if(is_main) margin(10, 10, 10, 10) else margin(2, 2, 2, 2),\n        text = element_text(family = input$font_family),\n        plot.title = element_text(hjust = 0.5, size = if(is_main) input$title_size else 10, face = \"bold\"),\n        # é¢„è§ˆå›¾éšè—è½´æ ‡é¢˜ä»¥èŠ‚çœç©ºé—´\n        axis.title.x = if(is_main) element_text(size = input$xtitle_size) else element_blank(),\n        axis.title.y = if(is_main) element_text(size = input$ytitle_size) else element_blank(),\n        axis.text.x = element_text(size = if(is_main) input$xtext_size else 8, color = \"black\"),\n        axis.text.y = element_text(size = if(is_main) input$ytext_size else 8, color = \"black\"),\n        axis.line = element_line(linewidth = input$axis_lwd),\n        axis.ticks = element_line(linewidth = input$axis_lwd),\n        legend.position = \"none\"\n      ) +\n      scale_fill_manual(values = rep(final_cols, length.out=20)) +\n      # åº”ç”¨ Y è½´è´´ç´§å’Œå‡€ç©ºé™åˆ¶\n      scale_y_continuous(expand = y_expand_vec, limits = c(0, y_limit_top)) +\n      labs(x = input$xlab_text, y = input$ylab_text, title = if(is_main) input$plot_title else NULL)\n    \n    if(input$show_points) {\n      p <- p + geom_point(data=data %>% mutate(Age=factor(Age, levels=levels_order)), \n                          aes(x=Age, y=Bio_RelExp), shape=21, fill=\"white\", size=input$point_size, stroke=0.8, position = position_jitter(width=0.08, seed=1))\n    }\n    \n    if(is_main) {\n      try({\n        if(length(levels_order) > 2) {\n          fit <- lm(Bio_RelExp ~ factor(Age, levels=levels_order), data = data)\n          hsd <- HSD.test(fit, \"factor(Age, levels = levels_order)\", group = TRUE)\n          ldf <- as.data.frame(hsd$groups) %>% tibble::rownames_to_column(\"Age\")\n          # åŠ¨æ€è®¡ç®—å­—æ¯ä½ç½®ï¼šåœ¨æœ€å¤§å€¼ä¸Šæ–¹ 5% å¤„ï¼Œé˜²æ­¢è¢« limits æˆªæ–­\n          p <- p + geom_text(data = stats %>% left_join(ldf, by=\"Age\"), \n                             aes(label=groups, y=M + S + (max_val * 0.05)), \n                             size=input$sig_size, fontface=\"bold\", vjust = 0)\n        } else {\n          test_res <- data %>% t_test(Bio_RelExp ~ Age) %>% add_significance() %>% add_xy_position(x=\"Age\")\n          p <- p + stat_pvalue_manual(test_res, label = \"p.signif\", size = input$sig_size, bracket.size = input$sig_lwd, tip.length = 0.02)\n        }\n      }, silent = TRUE)\n    }\n    return(p)\n  }\n  \n  output$main_plot <- renderPlot({\n    req(input$selected_gene, results())\n    plot_standard(results()[[input$selected_gene]] %>% filter(Rank == 1))\n  }, width = function() input$num_w * 85, height = function() input$num_h * 85)\n  \n  output$preview_plot <- renderPlot({\n    req(input$selected_gene, results()); all_ranks <- results()[[input$selected_gene]]\n    # é™åˆ¶æ˜¾ç¤ºæ•°é‡æˆ–ä¼˜åŒ–å¸ƒå±€\n    p_list <- lapply(sort(unique(all_ranks$Rank)), function(r) { \n      plot_standard(all_ranks %>% filter(Rank == r), is_main = FALSE) + \n        labs(title=paste(\"Rank\", r)) \n    })\n    # å¼ºåˆ¶å‹ç¼© patchwork é—´è·\n    wrap_plots(p_list, ncol=4) & theme(plot.margin = margin(2,2,2,2))\n  }) # é«˜åº¦ç”± UI ä¸­çš„ height=\"1200px\" æ§åˆ¶\n  \n  output$rank1_detail_table <- renderDT({ datatable(results()[[input$selected_gene]] %>% filter(Rank == 1), options = list(scrollX = T)) })\n  output$raw_table <- renderDT({ datatable(data_prepared(), options = list(scrollX = T)) })\n  \n  output$download_pdf <- downloadHandler(filename = function() { paste0(input$selected_gene, \".pdf\") }, content = function(file) { ggsave(file, plot = plot_standard(results()[[input$selected_gene]] %>% filter(Rank == 1)), width = input$num_w, height = input$num_h) })\n  output$download_svg <- downloadHandler(filename = function() { paste0(input$selected_gene, \".svg\") }, content = function(file) { ggsave(file, plot = plot_standard(results()[[input$selected_gene]] %>% filter(Rank == 1)), width = input$num_w, height = input$num_h) })\n}\n\nshinyApp(ui, server)","type":"text"}]
